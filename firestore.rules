rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function signedIn() {
      return request.auth != null;
    }

    function isAdminEmail() {
      return signedIn()
          && request.auth.token.email != null
          && request.auth.token.email in ['gkmwangi420@gmail.com', 'admin@example.com'];
    }

    function userDoc() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid));
    }

    function role() {
      return userDoc().data.role;
    }

    function hasAdminRole() {
      return userDoc().data.role == 'admin' || userDoc().data.isAdmin == true;
    }

    function isAdmin() {
      return signedIn() && (hasAdminRole() || isAdminEmail());
    }

    function hasSystemSettings() {
      return exists(/databases/$(database)/documents/settings/system);
    }

    function systemSettings() {
      return get(/databases/$(database)/documents/settings/system).data;
    }

    function maintenanceEnabled() {
      return hasSystemSettings()
          && (
            ('maintenance' in systemSettings() && systemSettings().maintenance.enabled == true)
            || ('maintenanceMode' in systemSettings() && systemSettings().maintenanceMode == true)
          );
    }

    function bookingEnabled() {
      return !hasSystemSettings()
          || !('booking' in systemSettings())
          || systemSettings().booking.enabled != false;
    }

    function doctorBookingActionsEnabled() {
      return !hasSystemSettings()
          || !('booking' in systemSettings())
          || systemSettings().booking.doctorBookingEnabled != false;
    }

    function minNoticeHours() {
      return hasSystemSettings()
          && 'booking' in systemSettings()
          && systemSettings().booking.minNoticeHours is int
          && systemSettings().booking.minNoticeHours >= 0
          ? systemSettings().booking.minNoticeHours
          : 2;
    }

    function cancellationDeadlineHours() {
      return hasSystemSettings()
          && 'booking' in systemSettings()
          && systemSettings().booking.cancellationDeadlineHours is int
          && systemSettings().booking.cancellationDeadlineHours >= 0
          ? systemSettings().booking.cancellationDeadlineHours
          : 3;
    }

    function allowNewPatients() {
      return !hasSystemSettings()
          || !('registration' in systemSettings())
          || systemSettings().registration.allowNewPatients != false;
    }

    function allowNewDoctors() {
      return !hasSystemSettings()
          || (
              ('registration' in systemSettings() && systemSettings().registration.allowNewDoctors != false)
              || (
                  !('registration' in systemSettings())
                  && (!('allowNewDoctors' in systemSettings()) || systemSettings().allowNewDoctors != false)
                )
            );
    }

    function patientRegistrationAllowed() {
      return !maintenanceEnabled() && allowNewPatients();
    }

    function doctorRegistrationAllowed() {
      return !maintenanceEnabled() && allowNewDoctors();
    }

    function isSelf(uid) {
      return signedIn() && request.auth.uid == uid;
    }

    function isValidRole(r) {
      return r in ['user', 'doctor', 'admin', 'patient'];
    }

    function isValidStatus(s) {
      return s in ['pending', 'confirmed', 'accepted', 'rejected', 'completed', 'cancelled', 'no_show'];
    }

    function isFinalStatus(s) {
      return s in ['completed', 'no_show'];
    }

    function canFinalizeAppointment() {
      return resource.data.appointmentTime is timestamp
          && request.time >= resource.data.appointmentTime;
    }

    function userEditableKeys() {
      return [
        'displayName',
        'photoUrl',
        'avatarUrl',
        'lastLoginAt',
        'updatedAt',
        'phone',
        'address',
        'dateOfBirth',
        'acceptedTermsVersion',
        'termsAcceptedAt'
      ];
    }

    function canSelfSetInitialRole() {
      return isSelf(request.auth.uid)
          && resource.data.role == null
          && isValidRole(request.resource.data.role)
          && (
            (request.resource.data.role in ['user', 'patient'] && patientRegistrationAllowed())
            || (request.resource.data.role == 'doctor' && doctorRegistrationAllowed())
            || (request.resource.data.role == 'admin' && isAdminEmail())
          )
          && request.resource.data.diff(resource.data).changedKeys().hasOnly([
            'uid',
            'email',
            'displayName',
            'photoUrl',
            'avatarUrl',
            'role',
            'status',
            'isAdmin',
            'createdAt',
            'lastLoginAt',
            'updatedAt'
          ]);
    }

    match /users/{uid} {
      allow read: if signedIn();

      allow create: if isSelf(uid)
          && isValidRole(request.resource.data.role)
          && (
            (request.resource.data.role in ['user', 'patient'] && patientRegistrationAllowed())
            || (request.resource.data.role == 'doctor' && doctorRegistrationAllowed())
            || (request.resource.data.role == 'admin' && isAdminEmail())
          );

      allow update: if isAdmin()
          || canSelfSetInitialRole()
          || (isSelf(uid)
              && request.resource.data.role == resource.data.role
              && request.resource.data.diff(resource.data).changedKeys().hasOnly(userEditableKeys()));

      allow delete: if isAdmin();
    }

    match /doctors/{doctorId} {
      allow read: if signedIn();
      allow create: if isAdmin() || (signedIn() && request.auth.uid == doctorId && doctorRegistrationAllowed());
      allow update: if isAdmin() || (signedIn() && request.auth.uid == doctorId);
      allow delete: if isAdmin();
    }

    match /appointments/{appointmentId} {
      allow read: if isAdmin()
          || (signedIn()
              && (resource.data.userId == request.auth.uid
                  || resource.data.doctorId == request.auth.uid));

      allow create: if signedIn()
          && !maintenanceEnabled()
          && bookingEnabled()
          && request.resource.data.userId == request.auth.uid
          && (request.resource.data.status == null || isValidStatus(request.resource.data.status))
          && request.resource.data.appointmentTime is timestamp
          && request.resource.data.appointmentTime >= request.time + duration.value(minNoticeHours(), 'h');

      allow update: if isAdmin()
          || (signedIn()
              && request.auth.uid == resource.data.doctorId
              && doctorBookingActionsEnabled()
              && (
                (
                  isValidStatus(request.resource.data.status)
                  && request.resource.data.statusUpdatedByRole == 'doctor'
                  && request.resource.data.statusUpdatedById == request.auth.uid
                  && request.resource.data.diff(resource.data).changedKeys().hasOnly([
                    'status',
                    'notes',
                    'statusUpdatedByRole',
                    'statusUpdatedById',
                    'updatedAt'
                  ])
                  && (!isFinalStatus(request.resource.data.status) || canFinalizeAppointment())
                )
                || (
                  request.resource.data.status == resource.data.status
                  && request.resource.data.diff(resource.data).changedKeys().hasOnly([
                    'notes',
                    'updatedAt'
                  ])
                )
              ))
          || (signedIn()
              && request.auth.uid == resource.data.userId
              && request.resource.data.status == 'cancelled'
              && request.resource.data.statusUpdatedByRole == 'patient'
              && request.resource.data.statusUpdatedById == request.auth.uid
              && resource.data.appointmentTime is timestamp
              && request.time + duration.value(cancellationDeadlineHours(), 'h') <= resource.data.appointmentTime
              && request.resource.data.diff(resource.data).changedKeys().hasOnly([
                'status',
                'statusUpdatedByRole',
                'statusUpdatedById',
                'updatedAt'
              ]));

      allow delete: if isAdmin();
    }

    function canBookSlot() {
      return signedIn()
          && resource.data.isBooked == false
          && request.resource.data.isBooked == true
          && request.resource.data.bookedBy == request.auth.uid
          && request.resource.data.startTime == resource.data.startTime
          && request.resource.data.endTime == resource.data.endTime
          && request.resource.data.diff(resource.data).changedKeys().hasOnly([
            'isBooked',
            'bookedBy',
            'bookedAt',
            'updatedAt'
          ]);
    }

    match /availability/{doctorId}/slots/{slotId} {
      allow read: if signedIn();
      allow create, delete: if isAdmin() || (signedIn() && request.auth.uid == doctorId);
      allow update: if isAdmin() || (signedIn() && request.auth.uid == doctorId) || canBookSlot();
    }

    match /roles/{roleName} {
      allow read: if signedIn();
      allow write: if isAdmin();
    }

    match /settings/{docId} {
      allow read: if signedIn();
      allow write: if isAdmin();
    }

    match /notification_events/{eventId} {
      allow read: if isAdmin();
      allow create: if signedIn()
          && request.resource.data.type is string
          && request.resource.data.appointmentId is string
          && request.resource.data.status == 'pending'
          && request.resource.data.createdAt == request.time;
      allow update, delete: if isAdmin();
    }

    match /moderation_events/{eventId} {
      allow read: if isAdmin();
      allow create: if signedIn()
          && request.resource.data.kind is string
          && request.resource.data.targetId is string
          && request.resource.data.doctorId is string
          && (
            isAdmin()
            || request.resource.data.doctorId == request.auth.uid
          )
          && request.resource.data.status == 'pending_review'
          && request.resource.data.createdAt == request.time;
      allow update, delete: if isAdmin();
    }

    match /{document=**} {
      allow read, write: if isAdmin();
    }
  }
}
