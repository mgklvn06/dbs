rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function signedIn() {
      return request.auth != null;
    }

    function isAdminEmail() {
      return signedIn()
          && request.auth.token.email != null
          && request.auth.token.email in ['admin@example.com'];
    }

    function userDoc() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid));
    }

    function userDocExists() {
      return signedIn()
          && exists(/databases/$(database)/documents/users/$(request.auth.uid));
    }

    function role() {
      return userDocExists()
          && 'role' in userDoc().data
          ? userDoc().data.role
          : null;
    }

    function hasAdminRole() {
      return role() == 'admin'
          || (userDocExists() && userDoc().data.isAdmin == true);
    }

    function isAdmin() {
      return signedIn() && (hasAdminRole() || isAdminEmail());
    }

    function isSuspendedAccount() {
      return userDocExists()
          && 'status' in userDoc().data
          && userDoc().data.status == 'suspended';
    }

    function isActiveSignedIn() {
      return signedIn() && !isSuspendedAccount();
    }

    function hasSystemSettings() {
      return exists(/databases/$(database)/documents/settings/system);
    }

    function systemSettings() {
      return get(/databases/$(database)/documents/settings/system).data;
    }

    function maintenanceEnabled() {
      return hasSystemSettings()
          && (
            ('maintenance' in systemSettings() && systemSettings().maintenance.enabled == true)
            || ('maintenanceMode' in systemSettings() && systemSettings().maintenanceMode == true)
          );
    }

    function allowNewPatients() {
      return !hasSystemSettings()
          || !('registration' in systemSettings())
          || systemSettings().registration.allowNewPatients != false;
    }

    function allowNewDoctors() {
      return !hasSystemSettings()
          || (
              ('registration' in systemSettings() && systemSettings().registration.allowNewDoctors != false)
              || (
                  !('registration' in systemSettings())
                  && (!('allowNewDoctors' in systemSettings()) || systemSettings().allowNewDoctors != false)
                )
            );
    }

    function patientRegistrationAllowed() {
      return !maintenanceEnabled() && allowNewPatients();
    }

    function doctorRegistrationAllowed() {
      return !maintenanceEnabled() && allowNewDoctors();
    }

    function isSelf(uid) {
      return signedIn() && request.auth.uid == uid;
    }

    function isValidRole(r) {
      return r in ['user', 'doctor', 'admin', 'patient'];
    }

    function isValidStatus(s) {
      return s in ['pending', 'confirmed', 'accepted', 'rejected', 'completed', 'cancelled', 'no_show'];
    }

    function appointmentDoctorMatches(doc) {
      return doc.doctorId == request.auth.uid
          || doc.doctorUid == request.auth.uid
          || doc.doctorUserId == request.auth.uid;
    }

    function appointmentPatientMatches(doc) {
      return doc.userId == request.auth.uid
          || doc.patientId == request.auth.uid
          || doc.patientUid == request.auth.uid;
    }

    function appointmentDateProvided(doc) {
      return doc.appointmentTime is timestamp
          || doc.dateTime is timestamp;
    }

    function userEditableKeys() {
      return [
        'displayName',
        'photoUrl',
        'avatarUrl',
        'lastLoginAt',
        'updatedAt',
        'phone',
        'address',
        'dateOfBirth',
        'acceptedTermsVersion',
        'termsAcceptedAt',
        'themeMode',
        'appearance',
        'privacySettings',
        'bookingPreferences',
        'notificationSettings',
        'preferredDoctorIds'
      ];
    }

    function canSelfSetInitialRole() {
      return isSelf(request.auth.uid)
          && resource.data.role == null
          && isValidRole(request.resource.data.role)
          && (
            (request.resource.data.role in ['user', 'patient'] && patientRegistrationAllowed())
            || (request.resource.data.role == 'doctor' && doctorRegistrationAllowed())
            || (request.resource.data.role == 'admin' && isAdminEmail())
          )
          && request.resource.data.diff(resource.data).changedKeys().hasOnly([
            'uid',
            'email',
            'displayName',
            'photoUrl',
            'avatarUrl',
            'role',
            'status',
            'isAdmin',
            'createdAt',
            'lastLoginAt',
            'updatedAt'
          ]);
    }

    function canSelfRequestDoctorDeletion(uid) {
      return isSelf(uid)
          && resource.data.role == 'doctor'
          && request.resource.data.role == resource.data.role
          && request.resource.data.accountStatus == 'deletion_requested'
          && request.resource.data.deletionRequestedAt == request.time
          && request.resource.data.diff(resource.data).changedKeys().hasOnly([
            'accountStatus',
            'deletionRequestedAt',
            'updatedAt'
          ]);
    }

    match /users/{uid} {
      allow read: if signedIn();

      allow create: if isSelf(uid)
          && isValidRole(request.resource.data.role)
          && (
            (request.resource.data.role in ['user', 'patient'] && patientRegistrationAllowed())
            || (request.resource.data.role == 'doctor' && doctorRegistrationAllowed())
            || (request.resource.data.role == 'admin' && isAdminEmail())
          );

      allow update: if isAdmin()
          || canSelfSetInitialRole()
          || canSelfRequestDoctorDeletion(uid)
          || (isSelf(uid)
              && request.resource.data.role == resource.data.role
              && request.resource.data.diff(resource.data).changedKeys().hasOnly(userEditableKeys()));

      allow delete: if isAdmin()
          || (isSelf(uid) && resource.data.role != 'doctor');
    }

    match /doctors/{doctorId} {
      allow read: if signedIn();
      allow create: if isAdmin() || (isActiveSignedIn() && request.auth.uid == doctorId && doctorRegistrationAllowed());
      allow update: if isAdmin() || (isActiveSignedIn() && request.auth.uid == doctorId);
      allow delete: if isAdmin();
    }

    match /appointments/{appointmentId} {
      allow read: if isAdmin()
          || (signedIn()
              && (
                appointmentPatientMatches(resource.data)
                || appointmentDoctorMatches(resource.data)
              ));

      allow create: if signedIn()
          && appointmentPatientMatches(request.resource.data)
          && (request.resource.data.status == null || isValidStatus(request.resource.data.status))
          && appointmentDateProvided(request.resource.data);

      allow update: if isAdmin()
          || (signedIn()
              && (
                appointmentDoctorMatches(resource.data)
                || role() == 'doctor'
              )
              && (
                (
                  isValidStatus(request.resource.data.status)
                  && request.resource.data.statusUpdatedByRole == 'doctor'
                  && request.resource.data.statusUpdatedById == request.auth.uid
                  && request.resource.data.diff(resource.data).changedKeys().hasOnly([
                    'status',
                    'notes',
                    'statusUpdatedByRole',
                    'statusUpdatedById',
                    'updatedAt'
                  ])
                )
                || (
                  request.resource.data.status == resource.data.status
                  && request.resource.data.diff(resource.data).changedKeys().hasOnly([
                    'notes',
                    'updatedAt'
                  ])
                )
              ))
          || (signedIn()
              && appointmentPatientMatches(resource.data)
              && request.resource.data.status == 'cancelled'
              && request.resource.data.statusUpdatedByRole == 'patient'
              && request.resource.data.statusUpdatedById == request.auth.uid
              && request.resource.data.diff(resource.data).changedKeys().hasOnly([
                'status',
                'statusUpdatedByRole',
                'statusUpdatedById',
                'updatedAt'
              ]));

      allow delete: if isAdmin();
    }

    function canBookSlot() {
      return signedIn()
          && resource.data.isBooked != true
          && request.resource.data.isBooked == true
          && request.resource.data.bookedBy == request.auth.uid
          && request.resource.data.diff(resource.data).changedKeys().hasOnly([
            'isBooked',
            'bookedBy',
            'bookedAt',
            'updatedAt'
          ]);
    }

    match /availability/{doctorId}/slots/{slotId} {
      allow read: if signedIn();
      allow create, delete: if isAdmin() || (signedIn() && request.auth.uid == doctorId);
      allow update: if isAdmin() || (signedIn() && request.auth.uid == doctorId) || canBookSlot();
    }

    match /roles/{roleName} {
      allow read: if signedIn();
      allow write: if isAdmin();
    }

    match /settings/{docId} {
      allow read: if signedIn() || docId == 'system';
      allow write: if isAdmin();
    }

    match /notification_events/{eventId} {
      allow read: if isAdmin();
      allow create: if signedIn()
          && request.resource.data.type is string
          && request.resource.data.appointmentId is string
          && request.resource.data.status == 'pending'
          && request.resource.data.createdAt == request.time;
      allow update, delete: if isAdmin();
    }

    match /moderation_events/{eventId} {
      allow read: if isAdmin();
      allow create: if signedIn()
          && request.resource.data.kind is string
          && request.resource.data.targetId is string
          && request.resource.data.doctorId is string
          && (
            isAdmin()
            || request.resource.data.doctorId == request.auth.uid
          )
          && request.resource.data.status == 'pending_review'
          && request.resource.data.createdAt == request.time;
      allow update, delete: if isAdmin();
    }

    match /{document=**} {
      allow read, write: if isAdmin();
    }
  }
}
